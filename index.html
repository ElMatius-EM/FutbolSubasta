<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gran DT - Subastas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* ESTILOS PERSONALIZADOS DEL ORIGINAL */
        .perspective-1000 { perspective: 1000px; }
        .preserve-3d { transform-style: preserve-3d; }
        
        /* FIX: Asegura que la cara trasera no se vea cuando está de espaldas */
        .backface-hidden { 
            -webkit-backface-visibility: hidden; 
            backface-visibility: hidden; 
        }
        
        .rotate-y-180 { transform: rotateY(180deg); }
        
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .animate-modal { animation: fade-in-up 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        body {
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
    </style>
</head>
<body class="h-screen bg-slate-950 flex flex-col font-sans overflow-hidden text-white">

    <div id="app" class="h-full w-full flex flex-col relative">
        </div>

<script>
// --- CONFIGURACIÓN DE FORMACIONES ---
const FORMATIONS = {
    '4-4-2': [
        { x: 50, y: 92, role: 'GK' },
        { x: 10, y: 75, role: 'DEF' }, { x: 35, y: 80, role: 'DEF' }, { x: 65, y: 80, role: 'DEF' }, { x: 90, y: 75, role: 'DEF' },
        { x: 15, y: 50, role: 'MID' }, { x: 38, y: 55, role: 'MID' }, { x: 62, y: 55, role: 'MID' }, { x: 85, y: 50, role: 'MID' },
        { x: 35, y: 20, role: 'FWD' }, { x: 65, y: 20, role: 'FWD' }
    ],
    '4-3-3': [
        { x: 50, y: 92, role: 'GK' },
        { x: 10, y: 75, role: 'DEF' }, { x: 35, y: 80, role: 'DEF' }, { x: 65, y: 80, role: 'DEF' }, { x: 90, y: 75, role: 'DEF' },
        { x: 25, y: 50, role: 'MID' }, { x: 50, y: 55, role: 'MID' }, { x: 75, y: 50, role: 'MID' },
        { x: 15, y: 20, role: 'FWD' }, { x: 50, y: 15, role: 'FWD' }, { x: 85, y: 20, role: 'FWD' }
    ],
    '3-5-2': [
        { x: 50, y: 92, role: 'GK' },
        { x: 25, y: 80, role: 'DEF' }, { x: 50, y: 80, role: 'DEF' }, { x: 75, y: 80, role: 'DEF' },
        { x: 10, y: 55, role: 'MID' }, { x: 30, y: 50, role: 'MID' }, { x: 50, y: 60, role: 'MID' }, { x: 70, y: 50, role: 'MID' }, { x: 90, y: 55, role: 'MID' },
        { x: 35, y: 20, role: 'FWD' }, { x: 65, y: 20, role: 'FWD' }
    ]
};

// --- BASE DE DATOS ---
const PLAYERS_DB = {
    GK: [
        { id: 'gk1', name: 'Franco Armani', team: 'River Plate', rating: 88, image: 'https://upload.wikimedia.org/wikipedia/commons/thumb/1/18/Franco_Armani_2018.jpg/245px-Franco_Armani_2018.jpg' },
        { id: 'gk2', name: 'Sergio Romero', team: 'Boca Juniors', rating: 86, image: 'https://upload.wikimedia.org/wikipedia/commons/thumb/c/bf/Sergio_Romero_2018.jpg/245px-Sergio_Romero_2018.jpg' },
        { id: 'gk3', name: 'Gabriel Arias', team: 'Racing Club', rating: 83, image: 'https://upload.wikimedia.org/wikipedia/commons/thumb/4/4c/Gabriel_Arias_2018.jpg/245px-Gabriel_Arias_2018.jpg' },
        { id: 'gk4', name: 'Guido Herrera', team: 'Talleres', rating: 81, image: 'https://upload.wikimedia.org/wikipedia/commons/thumb/e/e1/Guido_Herrera.jpg/245px-Guido_Herrera.jpg' }
    ],
    LD: [
        { id: 'ld1', name: 'Luis Advíncula', team: 'Boca Juniors', rating: 82, image: 'https://upload.wikimedia.org/wikipedia/commons/thumb/c/c5/Luis_Adv%C3%ADncula_2018.jpg/245px-Luis_Adv%C3%ADncula_2018.jpg' },
        { id: 'ld2', name: 'Fabricio Bustos', team: 'River Plate', rating: 80, image: 'https://upload.wikimedia.org/wikipedia/commons/thumb/6/6f/Fabricio_Bustos.jpg/245px-Fabricio_Bustos.jpg' },
        { id: 'ld3', name: 'Gastón Martirena', team: 'Racing Club', rating: 78, image: 'placeholder' },
        { id: 'ld4', name: 'Juan Barinaga', team: 'Boca Juniors', rating: 75, image: 'placeholder' }
    ],
    DFC1: [
        { id: 'dfc1a', name: 'Paulo Díaz', team: 'River Plate', rating: 87, image: 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a6/Paulo_D%C3%ADaz.jpg/245px-Paulo_D%C3%ADaz.jpg' },
        { id: 'dfc1b', name: 'Cristian Lema', team: 'Boca Juniors', rating: 80, image: 'placeholder' },
        { id: 'dfc1c', name: 'Marco Di Cesare', team: 'Racing Club', rating: 82, image: 'placeholder' },
        { id: 'dfc1d', name: 'Joaquín Laso', team: 'Independiente', rating: 76, image: 'placeholder' }
    ],
    DFC2: [
        { id: 'dfc2a', name: 'Marcos Rojo', team: 'Boca Juniors', rating: 84, image: 'https://upload.wikimedia.org/wikipedia/commons/thumb/1/15/Marcos_Rojo_2018.jpg/245px-Marcos_Rojo_2018.jpg' },
        { id: 'dfc2b', name: 'Germán Pezzella', team: 'River Plate', rating: 85, image: 'https://upload.wikimedia.org/wikipedia/commons/thumb/7/76/Germ%C3%A1n_Pezzella_2018.jpg/245px-Germ%C3%A1n_Pezzella_2018.jpg' },
        { id: 'dfc2c', name: 'Carlos Izquierdoz', team: 'Lanús', rating: 79, image: 'https://upload.wikimedia.org/wikipedia/commons/thumb/9/9c/Carlos_Izquierdoz.jpg/245px-Carlos_Izquierdoz.jpg' },
        { id: 'dfc2d', name: 'Walter Kannemann', team: 'Gremio (Invitado)', rating: 81, image: 'https://upload.wikimedia.org/wikipedia/commons/thumb/0/06/Walter_Kannemann.jpg/245px-Walter_Kannemann.jpg' }
    ],
    LI: [
        { id: 'li1', name: 'Marcos Acuña', team: 'River Plate', rating: 86, image: 'https://upload.wikimedia.org/wikipedia/commons/thumb/8/88/Marcos_Acu%C3%B1a_2018.jpg/245px-Marcos_Acu%C3%B1a_2018.jpg' },
        { id: 'li2', name: 'Lautaro Blanco', team: 'Boca Juniors', rating: 81, image: 'placeholder' },
        { id: 'li3', name: 'Gabriel Rojas', team: 'Racing Club', rating: 79, image: 'placeholder' },
        { id: 'li4', name: 'Malcom Braida', team: 'San Lorenzo', rating: 78, image: 'placeholder' }
    ],
    MCD: [
        { id: 'mcd1', name: 'Enzo Pérez', team: 'Estudiantes', rating: 85, image: 'https://upload.wikimedia.org/wikipedia/commons/thumb/4/4d/Enzo_P%C3%A9rez_2018.jpg/245px-Enzo_P%C3%A9rez_2018.jpg' },
        { id: 'mcd2', name: 'Santiago Ascacíbar', team: 'Estudiantes', rating: 82, image: 'https://upload.wikimedia.org/wikipedia/commons/thumb/9/95/Santiago_Ascacibar.jpg/245px-Santiago_Ascacibar.jpg' },
        { id: 'mcd3', name: 'Rodrigo Villagra', team: 'River Plate', rating: 79, image: 'placeholder' },
        { id: 'mcd4', name: 'Ivan Marcone', team: 'Independiente', rating: 78, image: 'placeholder' }
    ],
    MC: [
        { id: 'mc1', name: 'Pol Fernández', team: 'Boca Juniors', rating: 80, image: 'https://upload.wikimedia.org/wikipedia/commons/thumb/3/3d/Guillermo_Mat%C3%ADas_Fern%C3%A1ndez.jpg/245px-Guillermo_Mat%C3%ADas_Fern%C3%A1ndez.jpg' },
        { id: 'mc2', name: 'Santiago Simón', team: 'River Plate', rating: 81, image: 'placeholder' },
        { id: 'mc3', name: 'Juan Nardoni', team: 'Racing Club', rating: 79, image: 'placeholder' },
        { id: 'mc4', name: 'Rodrigo Aliendro', team: 'River Plate', rating: 82, image: 'placeholder' }
    ],
    MD: [
        { id: 'md1', name: 'Claudio Aquino', team: 'Vélez', rating: 86, image: 'placeholder' },
        { id: 'md2', name: 'Maxi Meza', team: 'River Plate', rating: 83, image: 'https://upload.wikimedia.org/wikipedia/commons/thumb/5/55/Maximiliano_Meza_2018.jpg/245px-Maximiliano_Meza_2018.jpg' },
        { id: 'md3', name: 'Exequiel Zeballos', team: 'Boca Juniors', rating: 81, image: 'placeholder' },
        { id: 'md4', name: 'Santiago Sosa', team: 'Racing Club', rating: 80, image: 'placeholder' }
    ],
    MI: [
        { id: 'mi1', name: 'Kevin Zenón', team: 'Boca Juniors', rating: 88, image: 'placeholder' },
        { id: 'mi2', name: 'Juanfer Quintero', team: 'Racing Club', rating: 85, image: 'https://upload.wikimedia.org/wikipedia/commons/thumb/4/43/Juan_Fernando_Quintero_2018.jpg/245px-Juan_Fernando_Quintero_2018.jpg' },
        { id: 'mi3', name: 'Pity Martínez', team: 'River Plate', rating: 84, image: 'placeholder' },
        { id: 'mi4', name: 'Franco Cervi', team: 'Celta (Posible)', rating: 80, image: 'placeholder' }
    ],
    DC1: [
        { id: 'dc1a', name: 'Edinson Cavani', team: 'Boca Juniors', rating: 89, image: 'https://upload.wikimedia.org/wikipedia/commons/thumb/2/22/Edinson_Cavani_2018.jpg/245px-Edinson_Cavani_2018.jpg' },
        { id: 'dc1b', name: 'Maravilla Martínez', team: 'Racing Club', rating: 86, image: 'placeholder' },
        { id: 'dc1c', name: 'Walter Bou', team: 'Lanús', rating: 82, image: 'placeholder' },
        { id: 'dc1d', name: 'Gabriel Ávalos', team: 'Independiente', rating: 80, image: 'placeholder' }
    ],
    DC2: [
        { id: 'dc2a', name: 'Miguel Borja', team: 'River Plate', rating: 88, image: 'https://upload.wikimedia.org/wikipedia/commons/thumb/4/43/Miguel_Borja_2018.jpg/245px-Miguel_Borja_2018.jpg' },
        { id: 'dc2b', name: 'Miguel Merentiel', team: 'Boca Juniors', rating: 85, image: 'placeholder' },
        { id: 'dc2c', name: 'Pablo Solari', team: 'River Plate', rating: 81, image: 'https://upload.wikimedia.org/wikipedia/commons/thumb/1/1a/Pablo_Solari.jpg/245px-Pablo_Solari.jpg' },
        { id: 'dc2d', name: 'Facundo Colidio', team: 'River Plate', rating: 82, image: 'placeholder' }
    ]
};

const ROUNDS_SCHEDULE = [
    { key: 'GK', label: 'Arquero', short: 'ARQ' },
    { key: 'LD', label: 'Lateral Derecho', short: 'LD' },
    { key: 'DFC1', label: 'Primer Central', short: 'DFC' },
    { key: 'DFC2', label: 'Segundo Central', short: 'DFC' },
    { key: 'LI', label: 'Lateral Izquierdo', short: 'LI' },
    { key: 'MCD', label: 'Volante Central (5)', short: 'MCD' },
    { key: 'MC', label: 'Volante Mixto', short: 'MC' },
    { key: 'MD', label: 'Volante Ofensivo Der.', short: 'MD' },
    { key: 'MI', label: 'Volante Creativo Izq.', short: 'MI' },
    { key: 'DC1', label: 'Delantero de Área', short: 'DC' },
    { key: 'DC2', label: 'Segundo Delantero', short: 'DC' }
];

const PENALTY_PLAYER = { name: 'Jugador Libre', team: 'Sin Club', rating: 55, image: null };
const INITIAL_BUDGET = 900;
const MIN_BID_INCREMENT = 10;
const INITIAL_SQUAD = {
    GK: null, LD: null, DFC1: null, DFC2: null, LI: null,
    MCD: null, MC: null, MD: null, MI: null,
    DC1: null, DC2: null
};

// --- ESTADO DE LA APLICACIÓN ---
let state = {
    phase: 'SETUP', // SETUP, AUCTION_BID, AUCTION_PICK, TACTICS
    roundIndex: 0,
    participants: [
        { id: 0, name: '', budget: INITIAL_BUDGET, squad: { ...INITIAL_SQUAD }, totalRating: 0, formation: '4-4-2' },
        { id: 1, name: '', budget: INITIAL_BUDGET, squad: { ...INITIAL_SQUAD }, totalRating: 0, formation: '4-4-2' },
        { id: 2, name: '', budget: INITIAL_BUDGET, squad: { ...INITIAL_SQUAD }, totalRating: 0, formation: '4-4-2' },
        { id: 3, name: '', budget: INITIAL_BUDGET, squad: { ...INITIAL_SQUAD }, totalRating: 0, formation: '4-4-2' },
    ],
    currentBids: { 0: 0, 1: 0, 2: 0, 3: 0 },
    pickOrder: [],
    currentPickerIndex: 0,
    availableCards: [],
    activeAuction: null
};

// --- LOGICA ---

function updateName(id, val) {
    state.participants[id].name = val;
    render();
}

function updateBid(id, val) {
    state.currentBids[id] = val;
    render(); // Re-render para mostrar el input actualizado
}

function startGame() {
    const filled = state.participants.map(p => ({ ...p, name: p.name || `DT ${p.id + 1}` }));
    state.participants = filled;
    startRound(0);
}

function startRound(rIdx) {
    state.roundIndex = rIdx;
    state.phase = 'AUCTION_BID';
    state.currentBids = { 0: 0, 1: 0, 2: 0, 3: 0 };
    const roundKey = ROUNDS_SCHEDULE[rIdx].key;
    const shuffledPlayers = [...PLAYERS_DB[roundKey]].sort(() => Math.random() - 0.5);
    state.availableCards = shuffledPlayers.map(p => ({ ...p, revealed: false, ownerId: null }));
    render();
}

function submitBids() {
    const bidsArray = state.participants.map(p => ({
        id: p.id,
        bid: parseInt(state.currentBids[p.id]) || 0
    })).sort((a, b) => b.bid - a.bid || Math.random() - 0.5);
    state.pickOrder = bidsArray;
    state.currentPickerIndex = 0;
    state.phase = 'AUCTION_PICK';
    render();
}

function handlePickCard(cardIndex) {
    if (state.availableCards[cardIndex].revealed) return;
    const currentPickerInfo = state.pickOrder[state.currentPickerIndex];
    
    state.activeAuction = {
        cardIndex: cardIndex,
        currentWinnerId: currentPickerInfo.id,
        currentPrice: currentPickerInfo.bid, 
        originalPickerId: currentPickerInfo.id,
        cardData: state.availableCards[cardIndex] 
    };
    render();
}

function handleLiveBid(bidderId) {
    if (!state.activeAuction) return;
    state.activeAuction.currentWinnerId = bidderId;
    state.activeAuction.currentPrice += MIN_BID_INCREMENT;
    render();
}

function finalizeAuction() {
    if (!state.activeAuction) return;
    const { cardIndex, currentWinnerId, currentPrice } = state.activeAuction;
    
    state.participants[currentWinnerId].budget -= currentPrice;
    let finalPlayer = state.availableCards[cardIndex];
    if (state.participants[currentWinnerId].budget < 0) {
        finalPlayer = { ...finalPlayer, ...PENALTY_PLAYER, name: `${finalPlayer.name} (Embargado)` };
    }

    const currentRoundInfo = ROUNDS_SCHEDULE[state.roundIndex];
    state.participants[currentWinnerId].squad[currentRoundInfo.key] = finalPlayer;

    state.availableCards[cardIndex].revealed = true;
    state.availableCards[cardIndex].ownerId = currentWinnerId;
    state.availableCards[cardIndex].finalStat = finalPlayer;

    state.activeAuction = null;
    advanceTurn();
}

function advanceTurn() {
    const currentRoundInfo = ROUNDS_SCHEDULE[state.roundIndex];
    const roundKey = currentRoundInfo.key;
    
    // Buscar el siguiente que no tenga carta en esta ronda
    // Usamos state.pickOrder para seguir el orden de pujas
    const nextPickerIndex = state.pickOrder.findIndex(p => state.participants[p.id].squad[roundKey] === null);
    
    if (nextPickerIndex !== -1) {
        state.currentPickerIndex = nextPickerIndex;
        render();
    } else {
        setTimeout(() => {
            if (state.roundIndex < ROUNDS_SCHEDULE.length - 1) {
                startRound(state.roundIndex + 1);
            } else {
                calculateFinalScores();
            }
        }, 1500);
        render(); // Para mostrar el último estado
    }
}

function calculateFinalScores() {
    state.participants = state.participants.map(p => {
        const stats = Object.values(p.squad).map(s => s ? s.rating : 0);
        const avg = Math.round(stats.reduce((a, b) => a + b, 0) / stats.length);
        return { ...p, totalRating: avg };
    });
    state.phase = 'TACTICS';
    render();
}

function changeFormation(pid, fmt) {
    state.participants[pid].formation = fmt;
    render();
}

function getPlayersByRole(squad, role) {
    if (role === 'GK') return [squad.GK];
    if (role === 'DEF') return [squad.LI, squad.DFC2, squad.DFC1, squad.LD].filter(Boolean);
    if (role === 'MID') return [squad.MI, squad.MCD, squad.MC, squad.MD].filter(Boolean);
    if (role === 'FWD') return [squad.DC1, squad.DC2].filter(Boolean);
    return [];
}

// --- RENDERIZADO ---

function render() {
    const app = document.getElementById('app');
    let html = '';

    // 1. SETUP PHASE
    if (state.phase === 'SETUP') {
        html += `
        <div class="absolute inset-0 z-50 bg-gradient-to-br from-blue-950 to-slate-950 flex flex-col items-center justify-center p-4">
            <div class="bg-white/10 backdrop-blur-xl p-6 md:p-8 rounded-3xl shadow-2xl max-w-lg w-full border border-white/10 flex flex-col max-h-[90vh] overflow-y-auto">
                <div class="text-center mb-6">
                    <h1 class="text-3xl md:text-4xl font-black mb-2 tracking-tighter uppercase text-yellow-400">Gran DT</h1>
                    <p class="text-blue-200 text-sm md:text-lg font-light">Liga Argentina • 44 Estrellas</p>
                </div>
                <div class="grid grid-cols-1 gap-4 mb-6">
                    ${state.participants.map((p, i) => `
                        <div class="flex flex-col gap-1">
                            <label class="text-[10px] font-bold text-blue-300 uppercase pl-1">DT ${i + 1}</label>
                            <input type="text" placeholder="Nombre del DT ${i + 1}" value="${p.name}" oninput="updateName(${i}, this.value)" class="w-full px-4 py-3 bg-slate-800/80 text-white rounded-xl font-bold border border-slate-700 focus:border-yellow-400 outline-none transition-all focus:bg-slate-800" />
                        </div>
                    `).join('')}
                </div>
                <button onclick="startGame()" class="w-full bg-gradient-to-r from-yellow-500 to-yellow-600 text-slate-900 font-black py-4 rounded-xl text-lg shadow-lg active:scale-95 transition-all">INICIAR TEMPORADA</button>
            </div>
        </div>`;
    }

    // 2. HEADER (Visible except Setup)
    if (state.phase !== 'SETUP') {
        const roundInfo = ROUNDS_SCHEDULE[state.roundIndex] || { label: 'Final' };
        html += `
        <header class="bg-slate-950 px-4 py-3 border-b border-white/10 flex justify-between items-center z-10 shrink-0 h-14 md:h-16">
            <div class="flex items-center gap-3">
                <div class="bg-yellow-500 text-slate-900 font-black px-2 py-1 md:px-3 md:py-1 rounded text-xs md:text-sm whitespace-nowrap">R ${state.roundIndex + 1}/11</div>
                <div class="leading-tight"><span class="text-[10px] md:text-xs text-slate-400 block uppercase">Mercado</span><span class="text-sm md:text-lg font-bold text-white uppercase text-yellow-400 truncate max-w-[150px] md:max-w-none block">${roundInfo.label}</span></div>
            </div>
            <div class="flex gap-2 text-[10px] md:text-xs font-medium">
                <div class="text-white bg-slate-800 px-2 py-1 md:px-3 rounded border border-slate-700">${state.phase}</div>
            </div>
        </header>`;
    }

    // 3. MAIN LAYOUT
    if (state.phase !== 'SETUP') {
        html += `<div class="flex-1 flex flex-col md:flex-row overflow-hidden relative">`;

        // SIDEBAR (Not in Tactics)
        if (state.phase !== 'TACTICS') {
            const activePickerId = state.pickOrder[state.currentPickerIndex]?.id;
            const roundKey = ROUNDS_SCHEDULE[state.roundIndex].key;

            html += `
            <div class="w-full md:w-80 bg-slate-900 border-b md:border-b-0 md:border-r border-white/5 flex flex-col shrink-0 h-[35vh] md:h-auto z-20">
                <div class="flex-1 overflow-y-auto no-scrollbar">
                    ${state.participants.map(p => {
                        const isCurrentPicker = state.phase === 'AUCTION_PICK' && activePickerId === p.id && !state.activeAuction;
                        const hasCardInRound = p.squad[roundKey] !== null;
                        const opacityClass = hasCardInRound ? 'opacity-50 grayscale' : '';
                        const activeClass = isCurrentPicker ? 'bg-yellow-500/10' : '';
                        const pulseClass = isCurrentPicker ? '<div class="absolute left-0 top-0 bottom-0 w-1 bg-yellow-400 animate-pulse"></div>' : '';
                        const turnIndicator = isCurrentPicker ? `<div class="mt-1 text-yellow-400 text-[10px] md:text-xs font-bold animate-pulse flex items-center gap-1"><i data-lucide="chevron-right" class="w-3 h-3"></i> TU TURNO</div>` : '';
                        const budgetColor = p.budget < 0 ? 'text-red-400' : 'text-green-400';
                        
                        let inputBlock = '';
                        if (state.phase === 'AUCTION_BID' && !hasCardInRound) {
                            inputBlock = `
                            <div class="flex items-center gap-2 mt-1">
                                <div class="relative group flex-1">
                                    <i data-lucide="dollar-sign" class="absolute left-2 top-1/2 -translate-y-1/2 w-3 h-3 text-slate-500"></i>
                                    <input type="number" class="w-full bg-slate-950 text-white pl-7 pr-2 py-1.5 rounded text-sm border border-slate-700 focus:border-yellow-400 outline-none font-mono" value="${state.currentBids[p.id] || ''}" oninput="updateBid(${p.id}, this.value)" placeholder="0" />
                                </div>
                            </div>`;
                        }

                        return `
                        <div class="p-3 md:p-5 border-b border-white/5 transition-all relative ${activeClass} ${opacityClass}">
                            ${pulseClass}
                            <div class="flex justify-between items-center mb-1 md:mb-2">
                                <div class="font-bold text-white text-sm md:text-lg leading-tight truncate w-1/2">${p.name}</div>
                                <div class="font-mono font-bold text-sm md:text-lg ${budgetColor}">$${p.budget}M</div>
                            </div>
                            ${inputBlock}
                            ${turnIndicator}
                        </div>`;
                    }).join('')}
                </div>
                ${state.phase === 'AUCTION_BID' ? `
                <div class="p-3 bg-slate-900 border-t border-white/10 shrink-0">
                    <button onclick="submitBids()" class="w-full bg-yellow-500 text-slate-900 font-bold py-3 rounded-lg shadow-lg active:scale-95 text-xs md:text-sm uppercase tracking-wider flex justify-center items-center gap-2"><i data-lucide="gavel" class="w-4 h-4"></i> OFERTAR</button>
                </div>` : ''}
            </div>`;
        }

        // GAME AREA (Mesa de Cartas)
        if (state.phase !== 'TACTICS') {
            const activePickerId = state.pickOrder[state.currentPickerIndex]?.id;
            
            html += `
            <div class="flex-1 relative bg-slate-800 flex flex-col items-center justify-center p-4 overflow-hidden">
                <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-30 pointer-events-none"></div>
                ${state.phase === 'AUCTION_PICK' && !state.activeAuction ? `
                <div class="bg-yellow-500 text-slate-900 px-4 py-2 rounded-full mb-4 md:mb-8 z-10 shadow-lg animate-bounce text-xs md:text-sm font-bold border-2 border-slate-900/10 text-center max-w-[80%] truncate">Turno: ${state.participants[activePickerId].name}</div>
                ` : ''}
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-8 z-10 w-full max-w-sm md:max-w-6xl h-full md:h-auto content-center">
                    ${state.availableCards.map((card, idx) => {
                        const isClickable = state.phase === 'AUCTION_PICK' && !card.revealed && !state.activeAuction && activePickerId !== undefined;
                        const pulse = isClickable ? 'animate-pulse' : '';
                        const cursor = card.revealed ? 'cursor-default' : 'cursor-pointer';
                        const clickHandler = isClickable ? `onclick="handlePickCard(${idx})"` : '';
                        const rotateClass = card.revealed ? 'rotate-y-180' : '';

                        return `
                        <div ${clickHandler} class="relative group perspective-1000 aspect-[3/4] ${cursor} ${pulse}">
                            <div class="w-full h-full transition-transform duration-700 preserve-3d relative ${rotateClass}">
                                <div class="absolute inset-0 backface-hidden bg-slate-700 rounded-xl shadow-lg border-4 border-slate-600 flex flex-col items-center justify-center z-20" style="transform: translateZ(0.1px)">
                                    <div class="w-16 h-16 md:w-24 md:h-24 bg-slate-800 rounded-full flex items-center justify-center mb-2 md:mb-4 shadow-inner">
                                        <i data-lucide="user" class="w-8 h-8 md:w-12 md:h-12 text-slate-500"></i>
                                    </div>
                                    <div class="text-yellow-500/20 font-black text-4xl md:text-6xl select-none absolute bottom-2 right-2">?</div>
                                </div>
                                <div class="absolute inset-0 backface-hidden rotate-y-180 bg-slate-900 rounded-xl shadow-lg border-4 border-slate-500 flex flex-col items-center justify-center z-10" style="transform: rotateY(180deg) translateZ(0.1px)">
                                    <div class="w-16 h-16 md:w-24 md:h-24 bg-slate-800 rounded-full flex items-center justify-center mb-3 shadow-lg">
                                        <i data-lucide="user" class="w-8 h-8 md:w-12 md:h-12 text-slate-600"></i>
                                    </div>
                                    <div class="bg-red-500 text-white font-black text-[10px] md:text-xs uppercase px-2 py-0.5 rounded transform -rotate-6 shadow mb-1">VENDIDO</div>
                                    <div class="text-white font-bold text-center text-xs md:text-base px-2 truncate w-full">${card.finalStat?.name || ''}</div>
                                </div>
                            </div>
                        </div>`;
                    }).join('')}
                </div>
            </div>`;
        } else {
            // TACTICS VIEW
            html += `
            <div class="absolute inset-0 z-50 bg-slate-950 flex flex-col items-center p-4 overflow-y-auto">
                <h1 class="text-3xl md:text-4xl font-black text-yellow-400 mb-2 mt-4 uppercase">Preparación Táctica</h1>
                
                <div class="grid grid-cols-1 gap-8 w-full max-w-6xl pb-20">
                    ${state.participants.map((p, i) => {
                        const formationPos = FORMATIONS[p.formation];
                        // Get players for nodes
                        const gk = getPlayersByRole(p.squad, 'GK');
                        const defs = getPlayersByRole(p.squad, 'DEF');
                        const mids = getPlayersByRole(p.squad, 'MID');
                        const fwds = getPlayersByRole(p.squad, 'FWD');
                        const allPlayers = [...gk, ...defs, ...mids, ...fwds];

                        return `
                        <div class="bg-slate-900 rounded-2xl border border-slate-800 overflow-hidden shadow-2xl flex flex-col md:flex-row">
                            <div class="w-full md:w-1/4 bg-slate-800 p-6 flex flex-col justify-center border-b md:border-b-0 md:border-r border-slate-700">
                                <h2 class="text-2xl font-black uppercase mb-1">${p.name}</h2>
                                <div class="text-slate-400 text-sm font-bold mb-4">Formación: ${p.formation}</div>
                                <div class="grid grid-cols-2 gap-2 mb-4">
                                    ${Object.keys(FORMATIONS).map(fmt => `
                                        <button onclick="changeFormation(${p.id}, '${fmt}')" class="px-2 py-1 rounded text-xs font-bold border ${p.formation === fmt ? 'bg-yellow-500 text-slate-900' : 'bg-slate-900 text-slate-400 border-slate-600'}">${fmt}</button>
                                    `).join('')}
                                </div>
                                <div class="mt-4">
                                    <h3 class="text-xs font-bold text-slate-500 uppercase mb-2 flex items-center gap-2"><i data-lucide="list" class="w-3 h-3"></i> Plantel Completo</h3>
                                    <ul class="space-y-1 text-xs md:text-sm font-medium text-slate-300">
                                        ${ROUNDS_SCHEDULE.map(r => {
                                            const player = p.squad[r.key];
                                            return `
                                            <li class="flex justify-between border-b border-white/5 pb-0.5 last:border-0">
                                                <span class="text-slate-500 w-8">${r.short}</span>
                                                <span class="${player ? 'text-white' : 'text-slate-600 italic'}">${player ? player.name : 'Vacante'}</span>
                                                ${player ? `<span class="text-yellow-500 font-bold ml-2">${player.rating}</span>` : ''}
                                            </li>`;
                                        }).join('')}
                                    </ul>
                                </div>
                            </div>
                            <div class="flex-1 bg-green-900/50 p-4 relative min-h-[300px]">
                                <div class="absolute inset-4 border-2 border-white/10 rounded-lg"></div>
                                <div class="absolute top-1/2 left-4 right-4 h-px bg-white/10"></div>
                                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-20 h-20 border-2 border-white/10 rounded-full"></div>
                                
                                ${formationPos.map((pos, idx) => {
                                    const player = allPlayers[idx];
                                    return `
                                    <div class="absolute flex flex-col items-center transform -translate-x-1/2 -translate-y-1/2 group" style="left: ${pos.x}%; top: ${pos.y}%">
                                        <div class="w-3 h-3 md:w-4 md:h-4 rounded-full shadow-lg border border-black/20 ${player ? 'bg-white' : 'bg-white/20'}"></div>
                                        ${player ? `
                                        <div class="mt-1 flex flex-col items-center">
                                            <div class="bg-slate-900/80 text-white text-[8px] md:text-[10px] px-2 py-0.5 rounded-sm font-bold uppercase whitespace-nowrap shadow-sm border border-white/10">
                                                ${player.name.split(' ').pop()}
                                            </div>
                                            <div class="text-[8px] font-black text-yellow-400 drop-shadow-sm leading-none mt-0.5">${player.rating}</div>
                                        </div>` : ''}
                                    </div>`;
                                }).join('')}

                                <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                                    <div class="bg-black/20 backdrop-blur-[1px] px-6 py-3 rounded-xl border border-white/10 text-center">
                                        <div class="text-white font-bold text-lg drop-shadow-md">Promedio de Equipo</div>
                                        <div class="text-4xl font-black text-yellow-400 drop-shadow-md">${p.totalRating}</div>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    }).join('')}
                </div>
                
                <div class="fixed bottom-0 left-0 right-0 p-4 bg-slate-950 border-t border-white/10 flex justify-center gap-4 z-50">
                    <button onclick="location.reload()" class="bg-white text-slate-900 px-8 py-3 rounded-full font-bold shadow-lg hover:scale-105 transition flex items-center gap-2">
                         <i data-lucide="rotate-ccw" class="w-4 h-4"></i> REINICIAR
                    </button>
                </div>
            </div>`;
        }

        html += `</div>`; // Close main layout
    }

    // 4. MODAL (Live Auction)
    if (state.activeAuction) {
        html += `
        <div class="absolute inset-0 z-50 bg-slate-950/90 backdrop-blur-md flex items-end md:items-center justify-center p-0 md:p-4">
            <div class="bg-white text-slate-900 rounded-t-3xl md:rounded-3xl w-full max-w-4xl max-h-[90vh] flex flex-col md:flex-row animate-modal shadow-2xl overflow-hidden">
                <div class="w-full md:w-5/12 bg-blue-700 p-6 flex flex-col items-center justify-center text-white relative shrink-0">
                    <div class="w-24 h-24 md:w-40 md:h-40 bg-white rounded-full flex items-center justify-center mb-2 md:mb-6 border-4 border-blue-400/50 shadow-xl overflow-hidden shrink-0">
                        ${state.activeAuction.cardData.image && state.activeAuction.cardData.image !== 'placeholder' ? 
                            `<img src="${state.activeAuction.cardData.image}" alt="${state.activeAuction.cardData.name}" class="w-full h-full object-cover" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">` : ''}
                        <i data-lucide="users" class="w-10 h-10 text-slate-300 ${state.activeAuction.cardData.image && state.activeAuction.cardData.image !== 'placeholder' ? 'hidden' : 'block'}"></i>
                    </div>
                    <h2 class="text-xl md:text-3xl font-black text-center leading-tight mb-1">${state.activeAuction.cardData.name}</h2>
                    <div class="flex items-center gap-2 mb-2"><i data-lucide="shirt" class="w-3 h-3 md:w-4 md:h-4 text-blue-300"></i> <span class="text-blue-100 text-xs md:text-base font-medium">${state.activeAuction.cardData.team}</span></div>
                    <div class="bg-white text-blue-900 px-4 py-1 md:px-6 md:py-2 rounded-lg font-black text-2xl md:text-4xl shadow-lg">${state.activeAuction.cardData.rating}</div>
                </div>
                <div class="w-full md:w-7/12 p-4 md:p-8 flex flex-col bg-slate-50 flex-1 overflow-hidden">
                    <div class="flex justify-between items-end mb-4 border-b border-slate-200 pb-2 shrink-0">
                        <div><h3 class="text-slate-400 font-bold text-[10px] uppercase">Precio</h3><div class="text-3xl md:text-5xl font-black text-green-600">$${state.activeAuction.currentPrice}M</div></div>
                        <div class="text-right"><h3 class="text-slate-400 font-bold text-[10px] uppercase">Líder</h3><div class="text-sm md:text-lg font-bold text-slate-800 bg-yellow-300 px-3 py-1 rounded-full truncate max-w-[120px]">${state.participants[state.activeAuction.currentWinnerId].name}</div></div>
                    </div>
                    <div class="flex-1 overflow-y-auto no-scrollbar mb-4 grid grid-cols-2 gap-2 md:gap-4 content-start">
                        ${state.participants.map(p => {
                            const isWinner = p.id === state.activeAuction.currentWinnerId;
                            const alreadyHasCard = p.squad[ROUNDS_SCHEDULE[state.roundIndex].key] !== null;
                            if (alreadyHasCard) return '';
                            
                            return `
                            <button onclick="handleLiveBid(${p.id})" ${isWinner ? 'disabled' : ''} class="p-3 rounded-xl border-2 flex flex-col items-center justify-center transition-all min-h-[80px] ${isWinner ? 'bg-green-50 border-green-500 cursor-default' : 'bg-white border-slate-200 active:bg-yellow-100 active:border-yellow-400'}">
                                <span class="font-bold text-slate-800 text-sm md:text-lg mb-1 truncate w-full text-center">${p.name}</span>
                                <div class="flex items-center gap-1 text-[10px] md:text-xs font-bold ${isWinner ? 'text-green-600' : 'text-slate-500'}">${isWinner ? 'GANANDO' : `+ $${MIN_BID_INCREMENT}M`}</div>
                            </button>`;
                        }).join('')}
                    </div>
                    <button onclick="finalizeAuction()" class="w-full bg-slate-900 text-white font-bold py-4 rounded-xl shadow-xl flex items-center justify-center gap-2 text-base md:text-lg active:bg-slate-800 shrink-0"><i data-lucide="hand-coins" class="w-5 h-5 text-yellow-400"></i> CERRAR VENTA</button>
                </div>
            </div>
        </div>`;
    }

    app.innerHTML = html;
    lucide.createIcons();
}

// Inicializar
render();

</script>
</body>
</html>
